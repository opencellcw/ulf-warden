/**
 * TESTE COMPLETO DO FLUXO DE GERAÃ‡ÃƒO DE IMAGENS
 * 
 * Testa TODOS os componentes end-to-end
 */

import { IntelligentImageEnhancer } from '../src/handlers/intelligent-image-enhancer';
import { extractReplicateImageInfo } from '../src/handlers/replicate-message-enhancer';
import { detectModelFromPrompt } from '../src/tools/replicate-enhanced';

// ============================================================================
// TEST DATA (Baseado no screenshot real)
// ============================================================================

const REAL_RESPONSE_FROM_BOT = `âœ… Image generated! | Nanobanana Pro | $0.0200

https://replicate.delivery/pbxt/abc123def456.png

Generated by Ulfberht`;

const VARIATIONS_TO_TEST = [
  {
    name: 'Format atual (screenshot)',
    input: REAL_RESPONSE_FROM_BOT,
    expectedURL: 'https://replicate.delivery/pbxt/abc123def456.png',
    expectedModel: 'Nanobanana Pro',
    expectedShouldEnhance: true
  },
  {
    name: 'Formato com markdown',
    input: `Aqui estÃ¡ sua imagem:

![Image](https://replicate.delivery/xyz/image.png)

Modelo: Flux Schnell
Custo: $0.002`,
    expectedURL: 'https://replicate.delivery/xyz/image.png',
    expectedModel: 'Flux Schnell',
    expectedShouldEnhance: true
  },
  {
    name: 'Formato com prompt longo',
    input: `âœ… Imagem gerada com sucesso!

Modelo: RealVisXL
Prompt: "Um viking Ã©pico segurando uma espada em chamas, fotorrealista, 8k"
ResoluÃ§Ã£o: 1024x1024

https://replicate.delivery/test/viking.png`,
    expectedURL: 'https://replicate.delivery/test/viking.png',
    expectedModel: 'RealVisXL',
    expectedShouldEnhance: true
  },
  {
    name: 'URL genÃ©rica (nÃ£o Replicate)',
    input: `Aqui estÃ¡ a imagem:

https://cdn.example.com/generated/image123.png

Gerada com AI Model`,
    expectedURL: 'https://cdn.example.com/generated/image123.png',
    expectedModel: 'AI Model',
    expectedShouldEnhance: true
  },
  {
    name: 'Mensagem sem imagem',
    input: `OlÃ¡! Como posso ajudar vocÃª hoje?`,
    expectedURL: null,
    expectedModel: null,
    expectedShouldEnhance: false
  },
  {
    name: 'URL mas nÃ£o Ã© imagem',
    input: `Confira este link: https://example.com/docs`,
    expectedURL: null,
    expectedModel: null,
    expectedShouldEnhance: false
  }
];

// ============================================================================
// TEST SUITE
// ============================================================================

async function runTests() {
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘                                                      â•‘');
  console.log('â•‘     ğŸ§ª IMAGE GENERATION FLOW - COMPLETE TEST ğŸ§ª      â•‘');
  console.log('â•‘                                                      â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  const enhancer = new IntelligentImageEnhancer();
  let totalTests = 0;
  let passedTests = 0;
  let failedTests = 0;

  for (const testCase of VARIATIONS_TO_TEST) {
    totalTests++;
    console.log(`\nğŸ“‹ Test ${totalTests}: ${testCase.name}`);
    console.log('â”€'.repeat(60));

    try {
      // Test 1: URL Detection
      console.log('\nğŸ” Step 1: URL Detection');
      const result = await enhancer.enhance(
        testCase.input,
        'test_user_123',
        'test_message_456'
      );

      // Validate URL detection
      if (testCase.expectedURL) {
        if (result.shouldEnhance && result.enhancedContent?.includes(testCase.expectedURL)) {
          console.log(`  âœ… URL detected: ${testCase.expectedURL}`);
        } else {
          console.log(`  âŒ URL not found! Expected: ${testCase.expectedURL}`);
          failedTests++;
          continue;
        }
      } else {
        if (!result.shouldEnhance) {
          console.log(`  âœ… Correctly skipped (no URL)`);
        } else {
          console.log(`  âŒ Should NOT have enhanced!`);
          failedTests++;
          continue;
        }
      }

      // Test 2: Model Detection
      console.log('\nğŸ¨ Step 2: Model Detection');
      if (testCase.expectedModel) {
        if (result.enhancedContent?.includes(testCase.expectedModel)) {
          console.log(`  âœ… Model detected: ${testCase.expectedModel}`);
        } else {
          console.log(`  âš ï¸  Model not exact match (may be ok)`);
        }
      }

      // Test 3: Button Creation
      console.log('\nğŸ”˜ Step 3: Button Creation');
      if (testCase.expectedShouldEnhance) {
        if (result.components && result.components.length > 0) {
          console.log(`  âœ… Buttons created: ${result.components.length} rows`);
          console.log(`     - Row 1: Regenerate, Remix, Video`);
          console.log(`     - Row 2: Ratio, Upscale, Download`);
        } else {
          console.log(`  âŒ No buttons created!`);
          failedTests++;
          continue;
        }
      }

      // Test 4: Enhanced Content
      console.log('\nğŸ“ Step 4: Enhanced Content');
      if (testCase.expectedShouldEnhance && result.enhancedContent) {
        console.log(`  âœ… Content enhanced (${result.enhancedContent.length} chars)`);
        console.log(`  âœ… Contains "Content Creation Studio": ${result.enhancedContent.includes('Content Creation Studio')}`);
      }

      passedTests++;
      console.log('\nâœ… TEST PASSED\n');

    } catch (error: any) {
      console.log(`\nâŒ TEST FAILED: ${error.message}\n`);
      failedTests++;
    }
  }

  // ============================================================================
  // ADDITIONAL TESTS: Model Detection Accuracy
  // ============================================================================

  console.log('\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘                                                      â•‘');
  console.log('â•‘        ğŸ¯ MODEL DETECTION ACCURACY TEST ğŸ¯           â•‘');
  console.log('â•‘                                                      â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  const modelTests = [
    { prompt: 'gera uma imagem com nanobanana pro', expected: 'nanobanana-pro' },
    { prompt: 'make it with flux schnell', expected: 'flux-schnell' },
    { prompt: 'use flux dev for best quality', expected: 'flux-dev' },
    { prompt: 'generate with sdxl', expected: 'sdxl' },
    { prompt: 'ultra realistic photo with epicrealism', expected: 'epicrealism' },
    { prompt: 'just make a simple image', expected: null }, // Should default to flux-schnell
  ];

  console.log('Testing smart model detection:\n');

  for (const test of modelTests) {
    const detected = detectModelFromPrompt(test.prompt);
    const expected = test.expected || 'flux-schnell'; // Default

    if (detected === expected) {
      console.log(`âœ… "${test.prompt}"`);
      console.log(`   â†’ Detected: ${detected}`);
      passedTests++;
    } else {
      console.log(`âŒ "${test.prompt}"`);
      console.log(`   â†’ Expected: ${expected}`);
      console.log(`   â†’ Got: ${detected}`);
      failedTests++;
    }
    totalTests++;
  }

  // ============================================================================
  // ADDITIONAL TESTS: Legacy enhanceReplicateMessage
  // ============================================================================

  console.log('\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘                                                      â•‘');
  console.log('â•‘      ğŸ“¦ LEGACY ENHANCER COMPATIBILITY TEST ğŸ“¦        â•‘');
  console.log('â•‘                                                      â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  console.log('Testing legacy extractReplicateImageInfo:\n');

  for (const testCase of VARIATIONS_TO_TEST.slice(0, 3)) {
    const info = extractReplicateImageInfo(testCase.input);
    totalTests++;

    if (testCase.expectedURL) {
      if (info && info.url === testCase.expectedURL) {
        console.log(`âœ… "${testCase.name}"`);
        console.log(`   â†’ URL: ${info.url}`);
        console.log(`   â†’ Model: ${info.model}`);
        console.log(`   â†’ Cost: $${info.cost}`);
        passedTests++;
      } else {
        console.log(`âŒ "${testCase.name}"`);
        console.log(`   â†’ Expected URL: ${testCase.expectedURL}`);
        console.log(`   â†’ Got: ${info ? info.url : 'null'}`);
        failedTests++;
      }
    } else {
      if (!info) {
        console.log(`âœ… "${testCase.name}" (correctly skipped)`);
        passedTests++;
      } else {
        console.log(`âŒ "${testCase.name}" (should not have extracted)`);
        failedTests++;
      }
    }
  }

  // ============================================================================
  // FINAL REPORT
  // ============================================================================

  console.log('\n\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘                                                      â•‘');
  console.log('â•‘              ğŸ“Š FINAL TEST REPORT ğŸ“Š                 â•‘');
  console.log('â•‘                                                      â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  console.log(`Total Tests:  ${totalTests}`);
  console.log(`âœ… Passed:    ${passedTests} (${((passedTests / totalTests) * 100).toFixed(1)}%)`);
  console.log(`âŒ Failed:    ${failedTests} (${((failedTests / totalTests) * 100).toFixed(1)}%)`);

  if (failedTests === 0) {
    console.log('\nğŸ‰ğŸ‰ğŸ‰ ALL TESTS PASSED! ğŸ‰ğŸ‰ğŸ‰\n');
    console.log('âœ… URL Detection: Working');
    console.log('âœ… Model Detection: Working');
    console.log('âœ… Button Creation: Working');
    console.log('âœ… Enhanced Content: Working');
    console.log('âœ… Smart Detection: Working');
    console.log('âœ… Legacy Support: Working');
  } else {
    console.log('\nâŒ SOME TESTS FAILED âŒ\n');
    console.log('Check the output above for details.');
  }

  console.log('\n' + 'â•'.repeat(60) + '\n');
}

// Run tests
runTests().catch(console.error);
