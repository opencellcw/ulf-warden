# üé® Fluxo Completo de Gera√ß√£o de Imagens - OpenCell v3.0

## üì∏ Screenshot Analisada

```
User: @ulf gera uma imagem realistica sua no nanobanana pro udh 8k

Bot: ‚úÖ Image generated! | NanoBanana Pro | $0.0200
     Generated by Ulfberht
     [Imagem anexada]
```

---

## üîÑ FLUXO ATUAL (Como est√° funcionando)

### **1. Mensagem do Usu√°rio**
```
Input: "@ulf gera uma imagem realistica sua no nanobanana pro udh 8k"
```

### **2. Parser do Discord Handler**
```typescript
// src/handlers/discord.ts
1. Detecta mention (@ulf)
2. Extrai comando: "gera uma imagem realistica sua no nanobanana pro udh 8k"
3. Envia para Claude com ferramentas dispon√≠veis
```

### **3. Claude Decision (Tool Selection)**
```typescript
// Claude analisa o prompt e decide usar:
Tool: replicate_generate_image

Input: {
  prompt: "imagem realistica sua no nanobanana pro udh 8k",
  model: "nanobanana-pro" (auto-detectado),
  user_id: "123456789"
}
```

### **4. Smart Model Detection**
```typescript
// src/tools/replicate-enhanced.ts
detectModelFromPrompt(prompt) {
  // Detecta keywords:
  "nanobanana", "nano banana" ‚Üí Nanobanana Pro
  "flux schnell", "fast" ‚Üí Flux Schnell
  "realistic", "photo" ‚Üí RealVisXL
  "ultra realistic" ‚Üí EpicRealism
  
  // Retorna: "nanobanana-pro"
}
```

### **5. Permission Check**
```typescript
// src/tools/replicate-enhanced.ts
canUseExpensiveAPI(userId) {
  // Checa se user √© admin
  const admins = AUTHORIZED_ADMIN_USERS.split(',');
  
  if (!admins.includes(userId)) {
    return {
      allowed: false,
      reason: "Only admins can use expensive models"
    };
  }
  
  return { allowed: true };
}
```

### **6. Replicate API Call**
```typescript
// src/tools/replicate.ts
const replicate = new Replicate();

const output = await replicate.run(
  "alvdansen/nanobanana-flux-dev-20b-5x5k:...",
  {
    input: {
      prompt: "imagem realistica sua no nanobanana pro udh 8k",
      aspect_ratio: "1:1",
      num_outputs: 1,
      guidance: 3.5,
      num_inference_steps: 28
    }
  }
);

// Cost tracking
const prediction = await replicate.predictions.get(output.id);
const cost = prediction.metrics.predict_time * 0.00072; // $0.02 avg
```

### **7. Response Format**
```typescript
// src/tools/replicate.ts
return `‚úÖ Image generated! | ${modelName} | $${cost.toFixed(4)}

${imageUrl}

Generated by Ulfberht`;
```

### **8. Message Enhancer (Add Buttons)**
```typescript
// src/handlers/replicate-message-enhancer.ts

// Detecta response com imagem
extractReplicateImageInfo(message);

// Adiciona bot√µes interativos:
- üîÑ Regenerate
- üìê Change Ratio
- ‚ö° Variations
- ‚ù§Ô∏è Save

// Salva sess√£o para tracking
saveGenerationSession({
  id: sessionId,
  prompt: originalPrompt,
  model: "nanobanana-pro",
  imageUrl: url,
  userId: userId
});
```

### **9. Discord Response**
```typescript
// src/handlers/discord.ts
await message.reply({
  content: formattedResponse,
  files: [imageUrl],
  components: [actionButtons] // Optional
});
```

---

## üìä DIAGRAMA DE FLUXO

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  USER: @ulf gera imagem realistica nanobanana 8k    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Discord Handler                                    ‚îÇ
‚îÇ  - Parse mention                                    ‚îÇ
‚îÇ  - Extract command                                  ‚îÇ
‚îÇ  - Get user ID                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Hybrid Dispatcher (NEW v3.0!)                      ‚îÇ
‚îÇ  - Complexity: TOOL_USE                             ‚îÇ
‚îÇ  - Route to: Pi (agent powers)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Pi Provider + Claude                               ‚îÇ
‚îÇ  - Analyze prompt                                   ‚îÇ
‚îÇ  - Select tool: replicate_generate_image            ‚îÇ
‚îÇ  - Prepare parameters                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Smart Model Detection                              ‚îÇ
‚îÇ  - Scan prompt for keywords                         ‚îÇ
‚îÇ  - "nanobanana" detected                            ‚îÇ
‚îÇ  - Model: "nanobanana-pro"                          ‚îÇ
‚îÇ  - Cost tier: EXPENSIVE ($0.02)                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Permission Check                                   ‚îÇ
‚îÇ  - Check user ID against AUTHORIZED_ADMIN_USERS     ‚îÇ
‚îÇ  - ‚úÖ Admin user ‚Üí ALLOWED                          ‚îÇ
‚îÇ  - ‚ùå Unknown ‚Üí BLOCKED                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Replicate API                                      ‚îÇ
‚îÇ  - POST to alvdansen/nanobanana-flux-dev-20b-5x5k   ‚îÇ
‚îÇ  - Input: { prompt, aspect_ratio, guidance }        ‚îÇ
‚îÇ  - Wait for prediction (~20-30s)                    ‚îÇ
‚îÇ  - Get output URL                                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Cost Tracking                                      ‚îÇ
‚îÇ  - Calculate: predict_time * rate_per_sec          ‚îÇ
‚îÇ  - Log to AgentOps/Langfuse                         ‚îÇ
‚îÇ  - Cost: $0.0200                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Response Formatter                                 ‚îÇ
‚îÇ  - Format: "‚úÖ Image generated! | Model | $Cost"    ‚îÇ
‚îÇ  - Add URL                                          ‚îÇ
‚îÇ  - Add attribution                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Message Enhancer (Optional)                        ‚îÇ
‚îÇ  - Detect Replicate image                           ‚îÇ
‚îÇ  - Add interactive buttons                          ‚îÇ
‚îÇ  - Save generation session                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Discord Reply                                      ‚îÇ
‚îÇ  - ‚úÖ Image generated! | NanoBanana Pro | $0.0200  ‚îÇ
‚îÇ  - [Image attachment]                               ‚îÇ
‚îÇ  - [Action buttons] (optional)                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ MODELOS SUPORTADOS (Auto-Detection)

| Keyword no Prompt | Modelo | Custo | Tempo | Qualidade |
|-------------------|--------|-------|-------|-----------|
| **nanobanana**, nano banana | Nanobanana Pro | $0.02 | 30s | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Art√≠stico |
| **flux schnell**, fast | Flux Schnell | $0.002 | 5s | ‚≠ê‚≠ê‚≠ê R√°pido |
| **flux dev**, best quality | Flux Dev | $0.02 | 25s | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Alta |
| **flux pro**, professional | Flux Pro | $0.02 | 30s | ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Produ√ß√£o |
| **realistic**, photo | RealVisXL | $0.002 | 10s | ‚≠ê‚≠ê‚≠ê‚≠ê Foto |
| **ultra realistic** | EpicRealism | $0.002 | 10s | ‚≠ê‚≠ê‚≠ê‚≠ê Retrato |
| **sdxl**, stable diffusion | SDXL | $0.002 | 8s | ‚≠ê‚≠ê‚≠ê Vers√°til |
| **playground**, aesthetic | Playground v2.5 | $0.002 | 10s | ‚≠ê‚≠ê‚≠ê‚≠ê Est√©tico |

**Default (sem keyword):** Flux Schnell (r√°pido e barato)

---

## üîê SISTEMA DE PERMISS√ïES

### **N√≠veis de Acesso:**

```typescript
1. ADMIN USERS (env: AUTHORIZED_ADMIN_USERS)
   ‚úÖ Pode usar TODOS os modelos
   ‚úÖ Sem limite de custo
   ‚úÖ Acesso a modelos caros (>$0.01)

2. KNOWN USERS (registrados no sistema)
   ‚ö†Ô∏è  Pode usar modelos baratos (<$0.005)
   ‚ö†Ô∏è  Bloqueado em modelos caros
   ‚ö†Ô∏è  Rate limit: 10 imagens/hora

3. UNKNOWN USERS
   ‚ùå BLOQUEADO de gerar imagens
   ‚ùå Recebe mensagem de erro
```

### **Verifica√ß√£o:**

```typescript
// src/tools/replicate-enhanced.ts

export function canUseExpensiveAPI(userId: string): {
  allowed: boolean;
  reason?: string;
} {
  const admins = process.env.AUTHORIZED_ADMIN_USERS?.split(',') || [];
  
  if (admins.includes(userId)) {
    return { allowed: true };
  }
  
  return {
    allowed: false,
    reason: "Expensive models are admin-only. Use free models (flux-schnell, sdxl, etc.)"
  };
}
```

---

## üí∞ CUSTOS E TRACKING

### **C√°lculo de Custo:**

```typescript
// src/tools/replicate.ts

const prediction = await replicate.predictions.get(predictionId);

// Custo baseado em tempo de execu√ß√£o
const predictTime = prediction.metrics.predict_time; // segundos
const costPerSecond = 0.00072; // NanoBanana Pro rate
const totalCost = predictTime * costPerSecond;

// Exemplo: 28s * $0.00072/s = $0.0202
```

### **Tracking Autom√°tico:**

```typescript
// 1. AgentOps (se habilitado)
agentops.recordToolUse({
  toolName: 'replicate_generate_image',
  model: 'nanobanana-pro',
  cost: 0.0200,
  success: true,
  userId: userId
});

// 2. Langfuse (se habilitado)
langfuse.trackGeneration({
  name: 'image_generation',
  model: 'nanobanana-pro',
  usage: {
    totalCost: 0.0200
  }
});

// 3. Redis Cache (hist√≥rico)
redis.zadd('user:image_generation:costs', Date.now(), JSON.stringify({
  userId,
  model: 'nanobanana-pro',
  cost: 0.0200,
  timestamp: Date.now()
}));
```

---

## üé® UI INTERATIVA (Bot√µes)

Quando a imagem √© gerada, bot√µes s√£o adicionados:

```typescript
// src/tools/replicate-ui.ts

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚úÖ Image generated! | NanoBanana   ‚îÇ
‚îÇ  [Imagem]                           ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  [üîÑ Regenerate] [üìê Ratio]         ‚îÇ
‚îÇ  [‚ö° Variations] [‚ù§Ô∏è Save]           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

A√ß√µes:
- üîÑ Regenerate: Gera novamente com mesmo prompt
- üìê Change Ratio: Menu 1:1, 16:9, 9:16, 4:3, 3:4
- ‚ö° Variations: Gera 4 varia√ß√µes sutis
- ‚ù§Ô∏è Save: Salva na collection do usu√°rio
```

### **Sess√£o de Gera√ß√£o:**

```typescript
// Salvo no Redis por 1 hora
{
  id: "img_abc123",
  userId: "123456789",
  prompt: "imagem realistica sua no nanobanana pro",
  model: "nanobanana-pro",
  imageUrl: "https://replicate.delivery/...",
  aspectRatio: "1:1",
  cost: 0.0200,
  timestamp: 1707779520000,
  expiresAt: 1707783120000 // +1 hora
}
```

---

## ‚ö° MELHORIAS SUGERIDAS

### **1. Integra√ß√£o com Pi Skills** ‚ú®

```typescript
// PROBLEMA ATUAL:
// Bot usa Claude diretamente, n√£o aproveita Pi skills

// SOLU√á√ÉO:
// Criar skill de gera√ß√£o de imagens para Pi

// ~/.pi/agent/skills/opencell-skills/image-generation/SKILL.md

Description: Generate images using Replicate with smart model detection

Triggers: "gera", "generate", "create image", "make picture"

Tools:
- replicate_generate_image (j√° existe)

Usage:
1. Detect trigger keywords in user message
2. Extract prompt and model hints
3. Use replicate_generate_image tool
4. Format response with cost and model info
5. Add interactive buttons (Discord)

Example:
User: "gera uma imagem realistica de gato"
Bot: [loads skill] ‚Üí [detects model] ‚Üí [generates] ‚Üí [formats]
```

### **2. Cache de Prompts Similares** üíæ

```typescript
// src/tools/replicate-cache.ts

// Antes de chamar Replicate, checa cache
const similarPrompts = await redis.zrevrangebyscore(
  'image_cache',
  Date.now(),
  Date.now() - 7 * 24 * 60 * 60 * 1000, // √∫ltimos 7 dias
  'WITHSCORES'
);

// Calcula similaridade (fuzzy match)
for (const cached of similarPrompts) {
  const similarity = calculateSimilarity(prompt, cached.prompt);
  
  if (similarity > 0.9) { // 90% similar
    log.info('[ImageCache] Hit! Reusing cached image');
    return {
      ...cached,
      cached: true,
      cost: 0 // Sem custo!
    };
  }
}

// Se n√£o achar, gera normalmente
```

**Economia potencial:** 30-50% reduction em custos para prompts repetidos

### **3. Queue System para Alta Demanda** üìä

```typescript
// src/tools/replicate-queue.ts

// Problema: M√∫ltiplos usu√°rios solicitando ao mesmo tempo

// Solu√ß√£o: Queue com Bull/Redis
import Bull from 'bull';

const imageQueue = new Bull('image-generation', {
  redis: redisConfig
});

// Adiciona job √† queue
imageQueue.add('generate', {
  prompt,
  model,
  userId,
  priority: isAdmin ? 1 : 5 // Admins t√™m prioridade
}, {
  attempts: 3,
  backoff: {
    type: 'exponential',
    delay: 2000
  }
});

// Worker processa queue
imageQueue.process('generate', async (job) => {
  const { prompt, model, userId } = job.data;
  
  // Rate limit check
  const userCount = await redis.get(`user:${userId}:image_count:hour`);
  if (userCount >= 10) {
    throw new Error('Rate limit exceeded (10/hour)');
  }
  
  // Gera imagem
  const result = await replicateGenerateImage({...});
  
  // Incrementa contador
  await redis.incr(`user:${userId}:image_count:hour`);
  await redis.expire(`user:${userId}:image_count:hour`, 3600);
  
  return result;
});
```

### **4. Preview R√°pido com Modelo Barato** ‚ö°

```typescript
// Estrat√©gia de 2 fases:

// FASE 1: Preview r√°pido (Flux Schnell, 5s, $0.002)
const preview = await replicate.run('flux-schnell', {
  prompt: prompt,
  num_inference_steps: 4 // R√°pido
});

await message.reply({
  content: "‚ö° Preview gerado! Gerando vers√£o final...",
  files: [preview.url]
});

// FASE 2: Vers√£o final (Nanobanana Pro, 30s, $0.02)
const final = await replicate.run('nanobanana-pro', {
  prompt: prompt,
  num_inference_steps: 28 // Alta qualidade
});

await message.edit({
  content: "‚úÖ Vers√£o final! | NanoBanana Pro | $0.0200",
  files: [final.url]
});
```

**Vantagem:** Usu√°rio v√™ algo em 5s, n√£o fica esperando 30s

### **5. Galeria Pessoal (Save Feature)** üíæ

```typescript
// src/tools/replicate-gallery.ts

// Quando user clica "‚ù§Ô∏è Save"
await saveToGallery({
  userId: userId,
  imageUrl: imageUrl,
  prompt: prompt,
  model: model,
  cost: cost,
  timestamp: Date.now()
});

// User pode listar depois
@ulf minhas imagens

Bot:
üé® Sua Galeria (√∫ltimas 10):

1. "gato pirata" - NanoBanana Pro - 12/02 18:38
2. "paisagem cyberpunk" - Flux Dev - 12/02 15:22
3. "retrato realista" - EpicRealism - 11/02 20:15

Total: 24 imagens | Custo total: $0.48
```

### **6. Batch Generation** üì∏

```typescript
// Gerar m√∫ltiplas varia√ß√µes de uma vez

@ulf gera 4 varia√ß√µes de "gato astronauta" com flux schnell

Bot:
‚è≥ Gerando 4 imagens em paralelo...

// Usa Promise.all
const results = await Promise.all([
  replicate.run('flux-schnell', { prompt, seed: 1 }),
  replicate.run('flux-schnell', { prompt, seed: 2 }),
  replicate.run('flux-schnell', { prompt, seed: 3 }),
  replicate.run('flux-schnell', { prompt, seed: 4 })
]);

‚úÖ 4 imagens geradas! | Flux Schnell | $0.008 total
[Grid 2x2 com as 4 imagens]
```

---

## üêõ PROBLEMAS ATUAIS E FIXES

### **Problema 1: Bot√µes √†s vezes n√£o aparecem**

**Causa:** `replicate-message-enhancer.ts` usa regex fr√°gil

**Fix:**
```typescript
// Padr√£o mais robusto
const pattern = /‚úÖ\s*Image\s+generated!\s*\|\s*(.+?)\s*\|\s*\$(\d+\.\d+)/i;
```

### **Problema 2: Custo nem sempre √© preciso**

**Causa:** Algumas predictions n√£o retornam `metrics.predict_time`

**Fix:**
```typescript
// Fallback para custo m√©dio do modelo
const cost = prediction.metrics?.predict_time 
  ? prediction.metrics.predict_time * ratePerSecond
  : MODEL_DEFAULT_COSTS[modelName] || 0.02;
```

### **Problema 3: Sess√µes expiram r√°pido (1 hora)**

**Fix:**
```typescript
// Aumentar TTL para 24 horas
await redis.setex(
  `image_session:${sessionId}`,
  24 * 60 * 60, // 24 horas
  JSON.stringify(session)
);
```

### **Problema 4: N√£o funciona com Hybrid Dispatcher**

**Fix:** J√° est√° implementado! Hybrid Dispatcher detecta "TOOL_USE" e roteia para Pi.

---

## üìä M√âTRICAS RECOMENDADAS

### **KPIs para Monitorar:**

```typescript
1. **Images Generated**
   - Total por dia/semana/m√™s
   - Por usu√°rio
   - Por modelo

2. **Success Rate**
   - % de gera√ß√µes bem-sucedidas
   - % de falhas (por reason)

3. **Cost**
   - Total gasto
   - Por usu√°rio
   - Por modelo
   - Economia com cache

4. **Performance**
   - Tempo m√©dio de gera√ß√£o
   - Por modelo
   - Queue wait time (se implementado)

5. **User Engagement**
   - Uso de bot√µes (regenerate, variations)
   - Saves na galeria
   - Re-requests (mesmo prompt)
```

### **Dashboard Example:**

```
üé® Image Generation Dashboard

üìä Today:
  - Images: 143 generated
  - Cost: $2.86
  - Success: 98.6%
  - Avg time: 15.2s

üèÜ Top Models:
  1. Flux Schnell: 85 (59%)
  2. NanoBanana Pro: 32 (22%)
  3. RealVisXL: 18 (13%)

üí∞ Cost Breakdown:
  - Cheap models: $0.17 (6%)
  - Expensive models: $2.69 (94%)

‚ö° Cache:
  - Hit rate: 12%
  - Saved: $0.34
```

---

## üéØ ROADMAP

### **Curto Prazo (1-2 semanas):**
- [ ] Fix: Padr√£o regex mais robusto
- [ ] Fix: Custo preciso com fallback
- [ ] Feature: Cache de prompts similares
- [ ] Feature: Preview r√°pido (2 fases)

### **M√©dio Prazo (1 m√™s):**
- [ ] Feature: Queue system (Bull)
- [ ] Feature: Galeria pessoal
- [ ] Feature: Batch generation
- [ ] Integration: Pi skills completo

### **Longo Prazo (3 meses):**
- [ ] Feature: Fine-tuning de modelos
- [ ] Feature: LoRA personalizadas
- [ ] Feature: Video generation
- [ ] Feature: Image editing (inpainting, outpainting)

---

## üìö DOCUMENTA√á√ÉO DE REFER√äNCIA

- **Replicate API:** https://replicate.com/docs
- **Nanobanana Pro:** https://replicate.com/alvdansen/nanobanana-flux-dev-20b-5x5k
- **Flux Models:** https://replicate.com/black-forest-labs
- **C√≥digo fonte:** 
  - `src/tools/replicate.ts`
  - `src/tools/replicate-enhanced.ts`
  - `src/tools/replicate-ui.ts`
  - `src/handlers/replicate-message-enhancer.ts`

---

**Last Updated:** February 12, 2026  
**Version:** 3.0.0  
**Status:** ‚úÖ Production (com melhorias sugeridas)
